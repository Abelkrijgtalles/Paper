From 3aeeaf31b7a7f888f54e47826e8ec0ddbe65c4bf Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 14:37:42 +0100
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/entity/Leashable.java b/net/minecraft/world/entity/Leashable.java
index bc4a74ebf631b60f3d04273a8c671c05889ff5f9..8e115fa3039be5ce6917728cda2a7e756af88a13 100644
--- a/net/minecraft/world/entity/Leashable.java
+++ b/net/minecraft/world/entity/Leashable.java
@@ -56,7 +56,13 @@ public interface Leashable {
     @Nullable
     private static Leashable.LeashData readLeashDataInternal(CompoundTag tag) {
         if (tag.contains("leash", 10)) {
-            return new Leashable.LeashData(Either.left(tag.getCompound("leash").getUUID("UUID")));
+            // Paper start
+            final CompoundTag leashTag = tag.getCompound("leash");
+            if (!leashTag.hasUUID("UUID")) {
+                return null;
+            }
+            return new Leashable.LeashData(Either.left(leashTag.getUUID("UUID")));
+            // Paper end
         } else {
             if (tag.contains("leash", 11)) {
                 Either<UUID, BlockPos> either = NbtUtils.readBlockPos(tag, "leash").<Either<UUID, BlockPos>>map(Either::right).orElse(null);
@@ -72,6 +78,11 @@ public interface Leashable {
     default void writeLeashData(CompoundTag tag, @Nullable Leashable.LeashData leashData) {
         if (leashData != null) {
             Either<UUID, BlockPos> either = leashData.delayedLeashInfo;
+            // CraftBukkit start - SPIGOT-7487: Don't save (and possible drop) leash, when the holder was removed by a plugin
+            if (leashData.leashHolder != null && leashData.leashHolder.pluginRemoved) {
+                return;
+            }
+            // CraftBukkit end
             if (leashData.leashHolder instanceof LeashFenceKnotEntity leashFenceKnotEntity) {
                 either = Either.right(leashFenceKnotEntity.getPos());
             } else if (leashData.leashHolder != null) {
@@ -104,7 +115,9 @@ public interface Leashable {
             }
 
             if (entity.tickCount > 100) {
+                entity.forceDrops = true; // CraftBukkit
                 entity.spawnAtLocation(serverLevel, Items.LEAD);
+                entity.forceDrops = false; // CraftBukkit
                 entity.setLeashData(null);
             }
         }
@@ -128,7 +141,9 @@ public interface Leashable {
             entity.onLeashRemoved();
             if (entity.level() instanceof ServerLevel serverLevel) {
                 if (dropItem) {
+                    entity.forceDrops = true; // CraftBukkit
                     entity.spawnAtLocation(serverLevel, Items.LEAD);
+                    entity.forceDrops = false; // CraftBukkit
                 }
 
                 if (broadcastPacket) {
@@ -146,7 +161,15 @@ public interface Leashable {
 
         if (leashData != null && leashData.leashHolder != null) {
             if (!entity.isAlive() || !leashData.leashHolder.isAlive()) {
-                if (level.getGameRules().getBoolean(GameRules.RULE_DOENTITYDROPS)) {
+                // Paper start - Expand EntityUnleashEvent
+                final org.bukkit.event.entity.EntityUnleashEvent event = new org.bukkit.event.entity.EntityUnleashEvent(
+                    entity.getBukkitEntity(),
+                    !entity.isAlive() ? org.bukkit.event.entity.EntityUnleashEvent.UnleashReason.PLAYER_UNLEASH : org.bukkit.event.entity.EntityUnleashEvent.UnleashReason.HOLDER_GONE,
+                    level.getGameRules().getBoolean(GameRules.RULE_DOENTITYDROPS) && !entity.pluginRemoved
+                );
+                event.callEvent();
+                if (event.isDropLeash()) { // CraftBukkit - SPIGOT-7487: Don't drop leash, when the holder was removed by a plugin
+                    // Paper end - Expand EntityUnleashEvent
                     entity.dropLeash();
                 } else {
                     entity.removeLeash();
@@ -160,7 +183,7 @@ public interface Leashable {
                     return;
                 }
 
-                if (f > 10.0) {
+                if (f > entity.level().paperConfig().misc.maxLeashDistance.or(LEASH_TOO_FAR_DIST)) { // Paper - Configurable max leash distance
                     entity.leashTooFarBehaviour();
                 } else if (f > 6.0) {
                     entity.elasticRangeLeashBehaviour(leashHolder, f);
@@ -177,7 +200,21 @@ public interface Leashable {
     }
 
     default void leashTooFarBehaviour() {
-        this.dropLeash();
+        // CraftBukkit start
+        boolean dropLeash = true; // Paper
+        if (this instanceof Entity entity) {
+            // Paper start - Expand EntityUnleashEvent
+            final org.bukkit.event.entity.EntityUnleashEvent event = new org.bukkit.event.entity.EntityUnleashEvent(entity.getBukkitEntity(), org.bukkit.event.entity.EntityUnleashEvent.UnleashReason.DISTANCE, true);
+            if (!event.callEvent()) return;
+            dropLeash = event.isDropLeash();
+        }
+        // CraftBukkit end
+        if (dropLeash) {
+            this.dropLeash();
+        } else {
+            this.removeLeash();
+        }
+        // Paper end - Expand EntityUnleashEvent
     }
 
     default void closeRangeLeashBehaviour(Entity entity) {
