From 6a0255d07a09045c7b0d3db3fa88ccfd06092226 Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 14:37:42 +0100
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/block/CommandBlock.java b/net/minecraft/world/level/block/CommandBlock.java
index 15a74341633966c776ecb753fa18f9d5aad23626..318ecbf276c7b37b399bd4d43baabed7311d0844 100644
--- a/net/minecraft/world/level/block/CommandBlock.java
+++ b/net/minecraft/world/level/block/CommandBlock.java
@@ -70,6 +70,15 @@ public class CommandBlock extends BaseEntityBlock implements GameMasterBlock {
 
     private void setPoweredAndUpdate(Level level, BlockPos pos, CommandBlockEntity blockEntity, boolean powered) {
         boolean isPowered = blockEntity.isPowered();
+        // CraftBukkit start
+        org.bukkit.block.Block bukkitBlock = level.getWorld().getBlockAt(pos.getX(), pos.getY(), pos.getZ());
+        int old = isPowered ? 15 : 0;
+        int current = powered ? 15 : 0;
+
+        org.bukkit.event.block.BlockRedstoneEvent eventRedstone = new org.bukkit.event.block.BlockRedstoneEvent(bukkitBlock, old, current);
+        level.getCraftServer().getPluginManager().callEvent(eventRedstone);
+        powered = eventRedstone.getNewCurrent() > 0;
+        // CraftBukkit end
         if (powered != isPowered) {
             blockEntity.setPowered(powered);
             if (powered) {
@@ -126,7 +135,7 @@ public class CommandBlock extends BaseEntityBlock implements GameMasterBlock {
     @Override
     protected InteractionResult useWithoutItem(BlockState state, Level level, BlockPos pos, Player player, BlockHitResult hitResult) {
         BlockEntity blockEntity = level.getBlockEntity(pos);
-        if (blockEntity instanceof CommandBlockEntity && player.canUseGameMasterBlocks()) {
+        if (blockEntity instanceof CommandBlockEntity && (player.canUseGameMasterBlocks() || (player.isCreative() && player.getBukkitEntity().hasPermission("minecraft.commandblock")))) { // Paper - command block permission
             player.openCommandBlock((CommandBlockEntity)blockEntity);
             return InteractionResult.SUCCESS;
         } else {
