From 6a0255d07a09045c7b0d3db3fa88ccfd06092226 Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 14:37:42 +0100
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/redstone/ExperimentalRedstoneWireEvaluator.java b/net/minecraft/world/level/redstone/ExperimentalRedstoneWireEvaluator.java
index 8380cb8508a8bcfa5ede7830a39b9bf5619a6ae7..6249e03f46bdad7aed4dfe6cd7e7a161eba4a878 100644
--- a/net/minecraft/world/level/redstone/ExperimentalRedstoneWireEvaluator.java
+++ b/net/minecraft/world/level/redstone/ExperimentalRedstoneWireEvaluator.java
@@ -36,7 +36,16 @@ public class ExperimentalRedstoneWireEvaluator extends RedstoneWireEvaluator {
             int intValue = entry.getIntValue();
             int i = unpackPower(intValue);
             BlockState blockState = level.getBlockState(blockPos);
-            if (blockState.is(this.wireBlock) && !blockState.getValue(RedStoneWireBlock.POWER).equals(i)) {
+            // CraftBukkit start
+            int oldPower = blockState.getValue(RedStoneWireBlock.POWER); // Paper - Call BlockRedstoneEvent properly; get the previous power from the right state
+            if (oldPower != i) {
+                org.bukkit.event.block.BlockRedstoneEvent event = new org.bukkit.event.block.BlockRedstoneEvent(org.bukkit.craftbukkit.block.CraftBlock.at(level, blockPos), oldPower, i);
+                level.getCraftServer().getPluginManager().callEvent(event);
+
+                i = event.getNewCurrent();
+            }
+            if (blockState.is(this.wireBlock) && oldPower != i) {
+                // CraftBukkit end
                 int i1 = 2;
                 if (!updateShape || !flag) {
                     i1 |= 128;
