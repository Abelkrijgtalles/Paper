From 3aeeaf31b7a7f888f54e47826e8ec0ddbe65c4bf Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 14:37:42 +0100
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/redstone/ExperimentalRedstoneWireEvaluator.java b/net/minecraft/world/level/redstone/ExperimentalRedstoneWireEvaluator.java
index 56150649e4893070f57a08929c4940163296f31b..1fc3aaa3732ddbae5bb24f1985fc9fb5ffd5e554 100644
--- a/net/minecraft/world/level/redstone/ExperimentalRedstoneWireEvaluator.java
+++ b/net/minecraft/world/level/redstone/ExperimentalRedstoneWireEvaluator.java
@@ -36,7 +36,16 @@ public class ExperimentalRedstoneWireEvaluator extends RedstoneWireEvaluator {
             int intValue = entry.getIntValue();
             int i = unpackPower(intValue);
             BlockState blockState = level.getBlockState(blockPos);
-            if (blockState.is(this.wireBlock) && !blockState.getValue(RedStoneWireBlock.POWER).equals(i)) {
+            // CraftBukkit start
+            int oldPower = blockState.getValue(RedStoneWireBlock.POWER); // Paper - Call BlockRedstoneEvent properly; get the previous power from the right state
+            if (oldPower != i) {
+                org.bukkit.event.block.BlockRedstoneEvent event = new org.bukkit.event.block.BlockRedstoneEvent(org.bukkit.craftbukkit.block.CraftBlock.at(level, blockPos), oldPower, i);
+                level.getCraftServer().getPluginManager().callEvent(event);
+
+                i = event.getNewCurrent();
+            }
+            if (blockState.is(this.wireBlock) && oldPower != i) {
+                // CraftBukkit end
                 int i1 = 2;
                 if (!updateShape || !flag) {
                     i1 |= 128;
