From 6a0255d07a09045c7b0d3db3fa88ccfd06092226 Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 14:37:42 +0100
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/network/codec/ByteBufCodecs.java b/net/minecraft/network/codec/ByteBufCodecs.java
index f39ecd61bb22ab3c913ed100dac86e2c59418c57..4796f58117d1f00e8d95fbb838664182ae7a56c2 100644
--- a/net/minecraft/network/codec/ByteBufCodecs.java
+++ b/net/minecraft/network/codec/ByteBufCodecs.java
@@ -390,6 +390,48 @@ public interface ByteBufCodecs {
         };
     }
 
+    // Paper start - Track codec depth
+    static <B extends FriendlyByteBuf, V> StreamCodec<B, V> trackDepth(final StreamCodec<B, V> codec) {
+        return new StreamCodec<>() {
+            @Override
+            public V decode(B buffer) {
+                buffer.trackCodecDepth = true;
+                try {
+                    return codec.decode(buffer);
+                } finally {
+                    buffer.trackCodecDepth = false;
+                    buffer.codecDepth = 0;
+                }
+            }
+
+            @Override
+            public void encode(B buffer, V value) {
+                codec.encode(buffer, value);
+            }
+        };
+    }
+
+    static <B extends FriendlyByteBuf, V> StreamCodec<B, V> increaseDepth(final StreamCodec<B, V> codec) {
+        return new StreamCodec<>() {
+            @Override
+            public V decode(B buffer) {
+                if (!buffer.trackCodecDepth) {
+                    return codec.decode(buffer);
+                }
+                if (++buffer.codecDepth > 64) {
+                    throw new DecoderException("Too deep");
+                }
+                return codec.decode(buffer);
+            }
+
+            @Override
+            public void encode(B buffer, V value) {
+                codec.encode(buffer, value);
+            }
+        };
+    }
+    // Paper end - Track codec depth
+
     static <B extends ByteBuf, V> StreamCodec<B, Optional<V>> optional(final StreamCodec<B, V> codec) {
         return new StreamCodec<B, Optional<V>>() {
             @Override
